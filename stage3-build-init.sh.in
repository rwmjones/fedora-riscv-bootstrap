#!/bin/bash -

# Helper to build an SRPM in the stage3 environment.  DO NOT RUN
# THIS SCRIPT DIRECTLY!  Follow the instructions at:
#
# https://fedoraproject.org/wiki/Architectures/RISC-V/Bootstrapping

# Set up the PATH.  The GCC path is a hack because I wasn't able to
# find the right flags for configuring GCC.
PATH=/usr/libexec/gcc/riscv64-unknown-linux-gnu/6.1.0:\
/usr/local/bin:\
/usr/local/sbin:\
/usr/bin:\
/usr/sbin:\
/bin:\
/sbin
export PATH

# Root filesystem is mounted as ro, remount it as rw.
mount.static -o remount,rw /

# Mount standard filesystems.
mount.static -t proc /proc /proc
mount.static -t sysfs /sys /sys
mount.static -t tmpfs -o "nosuid,size=20%,mode=0755" tmpfs /run
mkdir -p /run/lock

# XXX devtmpfs

rm -f /dev/null
mknod /dev/null c 1 3
rm -f /dev/tty /dev/zero
mknod /dev/tty c 5 0
mknod /dev/zero c 1 5
rm -f /dev/random /dev/urandom
mknod /dev/random c 1 8
mknod /dev/urandom c 1 9

# Initialize dynamic linker cache.
ldconfig /usr/lib64 /usr/lib /lib64 /lib

# There is no hardware clock, just ensure the date is not miles out.
date `date -r /var/tmp +%m%d%H%M%Y`

hostname stage3
echo stage3.fedoraproject.org > /etc/hostname

echo
echo "This is the stage3 SRPM automatic builder"
echo "@SRPM@"
echo

PS1='stage3:\w\$ '
export PS1

# Cleanup function called on failure or exit.
cleanup ()
{
    set +e
    # Sync disks and shut down.
    sync
    sleep 5
    sync
    mount.static -o remount,ro / >&/dev/null
    poweroff
}
trap cleanup INT QUIT TERM EXIT ERR

if test ! -f /rpmsdone; then
  # On the first run, we need to install all the RPMs and then reboot.
  rpm -Uvh --nodeps /rpmbuild/RPMS/{noarch,riscv64}/*.rpm ||:
  rm -f /var/lib/rpm/__db*
  rpm --initdb ||:

  touch /rpmsdone
else
  # On the second run, we do the actual build.
  set -x
  set -e

  rpmbuild --rebuild /var/tmp/@SRPM@ \
           --define "debug_package %{nil}" \
           --define "_missing_doc_files_terminate_build %{nil}" \
           --define "_unitdir /usr/lib/systemd/system" \
           --define "_tmpfilesdir /usr/lib/tmpfiles.d" \
           --define "_udevrulesdir /usr/lib/udev/rules.d" \
           --define "_emacs_sitestartdir /usr/share/emacs/site-lisp/site-start.d" \
           --define "_emacs_sitelispdir /usr/share/emacs/site-lisp" \
           --nodeps \
           --nocheck

  touch /buildok
fi

# cleanup() is called automatically here.
